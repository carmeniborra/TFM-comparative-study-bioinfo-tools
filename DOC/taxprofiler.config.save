// Configuracion  HPC
singularity {
    enabled    = true
    autoMounts = true
    // expandir√° $HOME en el shell por ir entre comillas dobles
    runOptions = '-B /data/ucct/bi/references/ -B /scratch/bi/research/20250625_TFM_CIBORRA_IC-SM_T -B "$HOME"'
}

process {
    executor      = 'slurm'
    queue         = 'long_idx'
    jobName       = { "$task.name - $task.hash" }
    conda         = null

    errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }

    withName: 'KAIJU_KAIJU' {
        cpus          = 8
        errorStrategy = { task.exitStatus in [143,137,21,1] ? 'retry' : 'finish' }
        maxRetries    = 1
        // limite del crecimiento al maximo global
        memory        = { [349.GB * task.attempt, params.max_memory].min() }
        time          = { 6.h }
    }

    withName: 'GANON_CLASSIFY' {
        cpus          = 12
        errorStrategy = { task.exitStatus in [137,143,104] ? 'retry' : 'finish' }
        maxRetries    = 1
        memory        = { [150.GB * task.attempt, params.max_memory].min() }
        time          = { 12.h }
    }

    withName: 'NFCORE_TAXPROFILER:TAXPROFILER:PROFILING:DIAMOND_BLASTX' {
        cpus   = 12
        maxRetries    = 1
        memory        = { [80.GB * task.attempt, params.max_memory].min() }
        time   = { 110.h * task.attempt }
    }

    withName: 'NFCORE_TAXPROFILER:TAXPROFILER:PROFILING:KRAKENUNIQ_PRELOADEDKRAKENUNIQ.*' {
    	cpus   = 24        
    	memory = '250.GB'  
    	time   = '48.h'
    }

    withName: 'FALCO' {
        errorStrategy = 'ignore'
        maxRetries    = 1
    }

    withName: 'NFCORE_TAXPROFILER:TAXPROFILER:STANDARDISATION_PROFILES:TAXPASTA_MERGE' {
        cpus          = 2
        memory        = { [50.GB, params.max_memory].min() }
        time          = { 2.h }
        errorStrategy = 'ignore'
        maxRetries    = 1
    }
 
    withName: 'NFCORE_TAXPROFILER:TAXPROFILER:PROFILING:CENTRIFUGE_CENTRIFUGE' {
        cpus   = 4       // bajar un poco los hilos para bajar el pico de RAM
        memory = '200 GB'
        time   = { 24.h }
    }

    withName: 'FASTP_PAIRED' {
        ext.args = '--cut_front --cut_tail --cut_window_size 4 --cut_mean_quality 20 --length_required 50 --qualified_quality_phred 20'
    }
}

params {
    max_memory = 376.GB
    max_cpus   = 32
    max_time   = '24.h'
}
